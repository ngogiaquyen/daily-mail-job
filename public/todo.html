<!DOCTYPE html>
<html lang="vi" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>L·∫≠p K·∫ø Ho·∫°ch H√†ng Ng√†y</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ["Inter", "system-ui", "sans-serif"] },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      .completed-row {
        background-color: #d4edda; /* M√†u xanh nh·∫°t */
        opacity: 0.85;
        transition: background-color 0.3s;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="max-w-4xl mx-auto p-4 lg:p-8">
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
        <!-- Header -->
        <div
          class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-8 text-center"
        >
          <h1 class="text-3xl font-bold">L·∫≠p K·∫ø Ho·∫°ch H√†ng Ng√†y</h1>
          <p class="text-lg mt-2 opacity-90">
            H√£y l√™n k·∫ø ho·∫°ch ƒë·ªÉ ng√†y h√¥m nay th·∫≠t hi·ªáu qu·∫£!
          </p>
        </div>

        <div class="p-6 lg:p-8 space-y-8">
          <!-- Ch·ªçn ng√†y -->
          <div class="text-center">
            <label class="text-lg font-semibold text-gray-700 block mb-4"
              >Ch·ªçn ng√†y l·∫≠p k·∫ø ho·∫°ch</label
            >
            <input
              type="date"
              id="datePicker"
              class="px-6 py-4 text-lg border-2 border-indigo-300 rounded-xl focus:border-indigo-500 focus:outline-none w-full max-w-md"
            />
          </div>

          <!-- C√¥ng vi·ªác -->
          <section>
            <h2
              class="text-xl font-semibold text-gray-800 mb-5 flex items-center"
            >
              <span class="mr-3 text-2xl">‚úÖ</span> C√¥ng Vi·ªác C·∫ßn L√†m
            </h2>

            <div
              id="tasksList"
              class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"
            ></div>
          </section>

          <!-- T·ª´ v·ª±ng - 3 √¥ nh·∫≠p + b·∫£ng hi·ªÉn th·ªã -->
          <section class="bg-blue-50 rounded-xl p-6 border border-blue-200">
            <h2
              class="text-xl font-semibold text-blue-900 mb-5 flex items-center"
            >
              <span class="mr-3 text-2xl">üìö</span> T·ª´ V·ª±ng M·ªõi (Ti·∫øng Trung)
            </h2>

            <!-- B·∫£ng hi·ªÉn th·ªã t·ª´ v·ª±ng -->
            <div class="overflow-x-auto mb-6">
              <table class="w-full text-sm">
                <thead class="bg-blue-100">
                  <tr>
                    <th class="p-3 text-left font-semibold">Ch·ªØ H√°n</th>
                    <th class="p-3 text-left font-semibold">Pinyin</th>
                    <th class="p-3 text-left font-semibold">
                      Nghƒ©a ti·∫øng Vi·ªát
                    </th>
                    <th class="p-3 text-center"></th>
                  </tr>
                </thead>
                <tbody id="vocabList"></tbody>
              </table>
              <p
                id="emptyVocabMessage"
                class="text-blue-700 text-center py-8 font-medium"
              >
                Ch∆∞a c√≥ t·ª´ v·ª±ng n√†o cho ng√†y n√†y
              </p>
            </div>
          </section>

          <!-- ƒÇn u·ªëng & Chi ti√™u -->
          <div class="grid md:grid-cols-2 gap-6">
            <section
              class="bg-orange-50 rounded-xl p-6 border border-orange-200"
            >
              <h2 class="text-xl font-semibold text-orange-900 mb-4">
                üçú ƒÇn U·ªëng
              </h2>
              <textarea
                id="meals"
                rows="4"
                placeholder="S√°ng: b√°nh m√¨ + tr√† s·ªØa\nTr∆∞a: c∆°m g√†\nT·ªëi: salad"
                class="w-full px-5 py-4 border-2 border-orange-300 rounded-xl focus:border-orange-500 resize-none text-base"
              ></textarea>
            </section>

            <section
              class="bg-purple-50 rounded-xl p-6 border border-purple-200"
            >
              <h2 class="text-xl font-semibold text-purple-900 mb-4">
                üí∞ Chi Ti√™u
              </h2>
              <input
                type="text"
                id="expenses"
                placeholder="T·ªïng: 350.000 VNƒê"
                class="w-full px-5 py-4 border-2 border-purple-300 rounded-xl focus:border-purple-500 text-base"
              />
            </section>
          </div>

          <!-- Th·ªùi gian th√¥ng b√°o email -->
          <section class="bg-indigo-50 rounded-xl p-6 border border-indigo-200">
            <h2
              class="text-xl font-semibold text-indigo-900 mb-5 flex items-center"
            >
              <span class="mr-3 text-2xl">üîî</span> Th·ªùi Gian Nh·∫≠n Email Th√¥ng
              B√°o
            </h2>

            <div class="grid sm:grid-cols-2 gap-6 mb-6">
              <div>
                <label class="block text-sm font-medium text-indigo-800 mb-2"
                  >Email ch√†o bu·ªïi s√°ng</label
                >
                <input
                  type="time"
                  id="morningTime"
                  class="w-full px-5 py-4 border-2 border-indigo-300 rounded-xl focus:border-indigo-500 text-base"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-indigo-800 mb-2"
                  >Email t·ªïng k·∫øt bu·ªïi t·ªëi</label
                >
                <input
                  type="time"
                  id="eveningTime"
                  class="w-full px-5 py-4 border-2 border-indigo-300 rounded-xl focus:border-indigo-500 text-base"
                />
              </div>
            </div>
          </section>

          <!-- N√∫t h√†nh ƒë·ªông -->
          <div
            class="text-center pt-6 space-y-4 sm:space-y-0 sm:space-x-6 sm:flex sm:justify-center"
          >
            <button
              onclick="savePlan()"
              class="w-full sm:w-auto px-12 py-4 bg-green-600 text-white text-xl font-bold rounded-xl hover:bg-green-700 transition shadow-lg"
            >
              üíæ L∆∞u K·∫ø Ho·∫°ch
            </button>

            <a
              href="/"
              class="inline-block w-full sm:w-auto px-12 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-xl font-bold rounded-xl hover:from-indigo-700 hover:to-purple-700 transition shadow-lg text-center"
            >
              Trang ch·ªß
            </a>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ==== H√ÄM PH√ÅT √ÇM TI·∫æNG TRUNG (Web Speech API - ·ªïn ƒë·ªãnh 2025) ====
      function speakChinese(text) {
        if (!text || !text.trim()) return;

        const cleanText = text.trim();

        if ("speechSynthesis" in window) {
          const utterance = new SpeechSynthesisUtterance(cleanText);
          utterance.lang = "zh-CN";
          utterance.rate = 0.9;
          utterance.pitch = 1;
          utterance.volume = 1;

          speechSynthesis.cancel();
          speechSynthesis.speak(utterance);
        } else {
          alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ph√°t √¢m!");
        }
      }

      const datePicker = document.getElementById("datePicker");
      const tasksList = document.getElementById("tasksList");
      const vocabList = document.getElementById("vocabList");
      const emptyVocabMessage = document.getElementById("emptyVocabMessage");
      const morningTime = document.getElementById("morningTime");
      const eveningTime = document.getElementById("eveningTime");
      const displayMorning = document.getElementById("displayMorning");
      const displayEvening = document.getElementById("displayEvening");

      datePicker.value = new Date().toISOString().slice(0, 10);

      function updateTimeDisplay() {
        displayMorning.textContent = morningTime.value || "08:00";
        displayEvening.textContent = eveningTime.value || "20:00";
      }
      morningTime.addEventListener("change", updateTimeDisplay);
      eveningTime.addEventListener("change", updateTimeDisplay);

      datePicker.addEventListener("change", loadPlan);
      loadPlan();

      async function loadPlan() {
        const date = datePicker.value;
        if (!date) return;

        try {
          const res = await fetch(`/api/plan/${date}`);
          const plan = res.ok
            ? await res.json()
            : {
                tasks: [],
                vocab: [],
                meals: "",
                expenses: "",
                morningTime: null,
                eveningTime: null,
              };

          // Load tasks
          tasksList.innerHTML = "";
          (plan.tasks || []).forEach((task) => {
            const text = typeof task === "object" ? task.text : task;
            addTaskToList(text);
          });

          // Load vocab
          vocabList.innerHTML = "";
          let vocabItems = [];

          if (plan.vocab && plan.vocab.length > 0) {
            if (typeof plan.vocab[0] === "string") {
              plan.vocab.forEach((str) => {
                const trimmed = str.trim();
                if (trimmed)
                  vocabItems.push({ hanzi: "", pinyin: trimmed, meaning: "", completed: false });
              });
            } else if (typeof plan.vocab[0] === "object") {
              plan.vocab.forEach((item) => {
                vocabItems.push({
                  hanzi: item.hanzi || "",
                  pinyin: item.pinyin || item.text || "",
                  meaning: item.meaning || "",
                  completed: !!item.completed
                });
              });
            }
          }

          if (vocabItems.length === 0) {
            emptyVocabMessage.style.display = "block";
          } else {
            emptyVocabMessage.style.display = "none";
            vocabItems.forEach((item, index) =>
              addVocabToList(item.hanzi, item.pinyin, item.meaning, item.completed, index)
            );
          }

          document.getElementById("meals").value = plan.meals || "";
          document.getElementById("expenses").value = plan.expenses || "";
          morningTime.value = plan.morningTime || "";
          eveningTime.value = plan.eveningTime || "";
          updateTimeDisplay();
        } catch (err) {
          console.error("L·ªói load plan:", err);
        }
      }

      function addTaskToList(text) {
        if (!text.trim()) return;
        const div = document.createElement("div");
        div.className =
          "flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-200 hover:bg-gray-100 transition";

        div.innerHTML = `
                <span class="text-base text-gray-800">${text.trim()}</span>
                <button type="button" onclick="this.closest('div').remove()" class="text-red-600 hover:text-red-800 text-xl font-bold ml-4">√ó</button>
            `;

        tasksList.appendChild(div);
      }

      function addTask() {
        const input = document.getElementById("newTask");
        const text = input.value.trim();
        if (!text) return alert("Vui l√≤ng nh·∫≠p c√¥ng vi·ªác!");
        addTaskToList(text);
        input.value = "";
      }

      document.getElementById("newTask").addEventListener("keypress", (e) => {
        if (e.key === "Enter") addTask();
      });

      // Th√™m t·ª´ v·ª±ng v√†o b·∫£ng + h·ªó tr·ª£ ho√†n th√†nh khi b·∫•m nghe
      function addVocabToList(hanzi, pinyin, meaning, completed = false, serverIndex = null) {
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-blue-100 transition cursor-pointer";
        if (completed) tr.classList.add("completed-row");

        const hanziCell = `<td class="p-3 font-bold text-lg text-center">${hanzi || "-"}</td>`;
        const pinyinCell = `<td class="p-3 text-center">${pinyin || "-"}</td>`;
        const meaningCell = `<td class="p-3 text-center">${meaning || "-"}</td>`;

        tr.innerHTML = `
                ${hanziCell}
                ${pinyinCell}
                ${meaningCell}
                <td class="p-3 text-center">
                    <button type="button" onclick="event.stopPropagation(); this.closest('tr').remove()" 
                            class="text-red-600 hover:text-red-800 text-xl font-bold">√ó</button>
                </td>
            `;

        // B·∫•m v√†o d√≤ng ‚Üí ph√°t √¢m + ƒë√°nh d·∫•u ho√†n th√†nh (n·∫øu ch∆∞a ho√†n th√†nh)
        tr.addEventListener("click", async (e) => {
          if (e.target.tagName === "BUTTON") return;

          const textToSpeak = hanzi.trim() || pinyin.trim();
          if (textToSpeak && textToSpeak !== "-") {
            speakChinese(textToSpeak);
          }

          if (!completed && serverIndex !== null) {
            tr.classList.add("completed-row");

            // G·ªçi API ƒë·ªÉ l∆∞u tr·∫°ng th√°i ho√†n th√†nh
            await fetch(`/api/plan/${datePicker.value}/vocab-complete`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ vocabIndex: serverIndex })
            });
          }
        });

        vocabList.appendChild(tr);
      }

      // N√∫t th√™m t·ª´ v·ª±ng
      function addVocab() {
        const hanzi = document.getElementById("newHanzi").value.trim();
        const pinyin = document.getElementById("newPinyin").value.trim();
        const meaning = document.getElementById("newMeaning").value.trim();

        if (!hanzi && !pinyin && !meaning) {
          alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt tr∆∞·ªùng!");
          return;
        }

        // Khi th√™m m·ªõi th√¨ completed = false, serverIndex = null (s·∫Ω l∆∞u khi savePlan)
        addVocabToList(hanzi, pinyin, meaning, false, null);

        // X√≥a √¥ nh·∫≠p
        document.getElementById("newHanzi").value = "";
        document.getElementById("newPinyin").value = "";
        document.getElementById("newMeaning").value = "";

        emptyVocabMessage.style.display = "none";
      }

      // L∆∞u k·∫ø ho·∫°ch ‚Äì g·ª≠i k√®m completed
      async function savePlan() {
        const date = datePicker.value;
        if (!date) return alert("Vui l√≤ng ch·ªçn ng√†y!");

        // L·∫•y tasks
        const tasks = Array.from(tasksList.querySelectorAll("span")).map(
          (span) => span.textContent.trim()
        );

        // L·∫•y vocab k√®m tr·∫°ng th√°i completed
        const vocab = [];
        vocabList.querySelectorAll("tr").forEach((tr) => {
          const tds = tr.querySelectorAll("td");
          if (tds.length >= 3) {
            const hanzi = tds[0].textContent.trim();
            const pinyin = tds[1].textContent.trim();
            const meaning = tds[2].textContent.trim();
            const completed = tr.classList.contains("completed-row");
            if (hanzi !== "-" || pinyin !== "-" || meaning !== "-") {
              vocab.push({
                hanzi: hanzi === "-" ? "" : hanzi,
                pinyin: pinyin === "-" ? "" : pinyin,
                meaning: meaning === "-" ? "" : meaning,
                completed
              });
            }
          }
        });

        const res = await fetch("/api/plan", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            date,
            tasks,
            vocab,
            meals: document.getElementById("meals").value,
            expenses: document.getElementById("expenses").value,
            morningTime: morningTime.value || null,
            eveningTime: eveningTime.value || null,
          }),
        });

        if (res.ok) {
          alert("üéâ L∆∞u k·∫ø ho·∫°ch th√†nh c√¥ng!");
          updateTimeDisplay();
          await loadPlan(); // Reload ƒë·ªÉ l·∫•y l·∫°i serverIndex ch√≠nh x√°c
        } else {
          alert("‚ùå C√≥ l·ªói khi l∆∞u. Vui l√≤ng th·ª≠ l·∫°i.");
        }
      }
    </script>
  </body>
</html>