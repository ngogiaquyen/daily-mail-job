<!DOCTYPE html>
<html lang="vi" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch K·∫ø Ho·∫°ch C√° Nh√¢n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        #sidebarContent { height: calc(100vh - 80px); }
    </style>
</head>
<body class="bg-gray-100 h-full flex text-sm">

    <!-- Sidebar -->
    <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 bg-white shadow-xl transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-0 flex flex-col">
        <div class="flex items-center justify-between p-4 border-b shrink-0">
            <h2 class="text-lg font-bold text-indigo-700">üìÖ L·ªãch K·∫ø Ho·∫°ch</h2>
            <button id="closeSidebar" class="lg:hidden text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div id="sidebarContent" class="p-4 overflow-y-auto flex-1">
            <div class="mb-6">
                <h3 class="text-sm font-semibold text-gray-700 mb-3">üóìÔ∏è Th√°ng Hi·ªán T·∫°i & T∆∞∆°ng Lai</h3>
                <div id="futureDatesList" class="grid grid-cols-7 gap-2"></div>
            </div>

            <div>
                <h3 class="text-sm font-semibold text-gray-700 mb-3">üìú Qu√° Kh·ª© C√≥ K·∫ø Ho·∫°ch</h3>
                <div id="pastDatesList" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Overlay mobile -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-full">
        <header class="bg-white shadow-sm border-b px-4 py-3 flex items-center justify-between shrink-0">
            <button id="openSidebar" class="lg:hidden text-indigo-600 hover:text-indigo-800">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <h1 class="text-lg font-bold text-gray-800">
                <span id="selectedDateTitle" class="text-indigo-600"></span>
            </h1>
            <div class="w-8"></div>
        </header>

        <main class="flex-1 overflow-y-auto bg-gray-100">
            <div class="p-4 lg:p-6">
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden">


                    <div class="p-5 space-y-6">
                        <!-- C√¥ng vi·ªác -->
                        <section>
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-base font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-xl">‚úÖ</span> C√¥ng Vi·ªác C·∫ßn L√†m
                                </h3>
                                <div class="flex gap-2">
                                    <button onclick="copyJson()" title="Copy JSON k·∫ø ho·∫°ch"
                                            class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition text-gray-600 hover:text-gray-900">
                                        <i class="fas fa-copy text-sm"></i>
                                    </button>
                                    <button onclick="pasteJson()" title="Paste JSON k·∫ø ho·∫°ch"
                                            class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition text-gray-600 hover:text-gray-900">
                                        <i class="fas fa-paste text-sm"></i>
                                    </button>
                                </div>
                            </div>

                            <div id="tasksList" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4"></div>
                            <div class="flex gap-2">
                                <input type="text" id="newTask" placeholder="Th√™m c√¥ng vi·ªác..." 
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-xl focus:border-indigo-500 focus:outline-none text-sm">
                                <button onclick="addTask()" class="px-5 py-2 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 transition">
                                    Th√™m
                                </button>
                            </div>
                        </section>

                        <!-- T·ª´ v·ª±ng -->
                        <section class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                            <h3 class="text-base font-semibold text-blue-900 mb-2 flex items-center">
                                <span class="mr-2 text-lg">üìö</span> T·ª´ V·ª±ng M·ªõi
                            </h3>
                            <textarea id="vocab" rows="4" placeholder="apple - qu·∫£ t√°o\nbeautiful - xinh ƒë·∫πp"
                                      class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:border-blue-500 resize-none text-sm"></textarea>
                        </section>

                        <!-- ƒÇn u·ªëng & Chi ti√™u -->
                        <div class="grid md:grid-cols-2 gap-4">
                            <section class="bg-orange-50 rounded-xl p-4 border border-orange-200">
                                <h3 class="text-base font-semibold text-orange-900 mb-2">üçú ƒÇn U·ªëng</h3>
                                <textarea id="meals" rows="3" placeholder="S√°ng: ph·ªü\nTr∆∞a: c∆°m t·∫•m"
                                          class="w-full px-3 py-2 border border-orange-300 rounded-lg focus:border-orange-500 resize-none text-sm"></textarea>
                            </section>

                            <section class="bg-purple-50 rounded-xl p-4 border border-purple-200">
                                <h3 class="text-base font-semibold text-purple-900 mb-2">üí∞ Chi Ti√™u</h3>
                                <input type="text" id="expenses" placeholder="500.000 VNƒê"
                                       class="w-full px-3 py-2 border border-purple-300 rounded-lg focus:border-purple-500 text-sm">
                            </section>
                        </div>

                        <!-- Th√¥ng b√°o email - CHI TI·∫æT H∆†N -->
                        <section class="bg-indigo-50 rounded-xl p-4 border border-indigo-200">
                            <h3 class="text-base font-semibold text-indigo-900 mb-3 flex items-center">
                                <span class="mr-2 text-lg">üîî</span> Th√¥ng B√°o Email Cho Ng√†y N√†y
                            </h3>
                            <div class="grid sm:grid-cols-2 gap-4 mb-3">
                                <div>
                                    <label class="block text-xs text-indigo-700 mb-1">Email ch√†o bu·ªïi s√°ng</label>
                                    <input type="time" id="morningTime" class="w-full px-3 py-2 border border-indigo-300 rounded-lg focus:border-indigo-500 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs text-indigo-700 mb-1">Email t·ªïng k·∫øt bu·ªïi t·ªëi</label>
                                    <input type="time" id="eveningTime" class="w-full px-3 py-2 border border-indigo-300 rounded-lg focus:border-indigo-500 text-sm">
                                </div>
                            </div>
                            <div class="bg-indigo-100 rounded-lg p-3 text-center text-sm font-medium text-indigo-900">
                                <p>üì§ Email s√°ng s·∫Ω ƒë∆∞·ª£c g·ª≠i l√∫c: <strong id="displayMorning">08:00</strong></p>
                                <p class="mt-1">üì§ Email t·ªëi s·∫Ω ƒë∆∞·ª£c g·ª≠i l√∫c: <strong id="displayEvening">20:00</strong></p>
                                <p class="mt-2 text-xs opacity-80">(N·∫øu ƒë·ªÉ tr·ªëng ‚Üí d√πng m·∫∑c ƒë·ªãnh 08:00 v√† 20:00)</p>
                            </div>
                        </section>

                        <!-- N√∫t l∆∞u -->
                        <div class="text-center pt-4">
                            <button onclick="savePlan()" class="px-10 py-3 bg-green-600 text-white text-base font-bold rounded-xl hover:bg-green-700 transition shadow">
                                üíæ L∆∞u K·∫ø Ho·∫°ch
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const openBtn = document.getElementById('openSidebar');
    const closeBtn = document.getElementById('closeSidebar');
    const selectedDateTitle = document.getElementById('selectedDateTitle');
    const tasksList = document.getElementById('tasksList');
    const futureDatesList = document.getElementById('futureDatesList');
    const pastDatesList = document.getElementById('pastDatesList');

    let currentDate = new Date().toISOString().slice(0, 10);

    openBtn.onclick = () => { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); }
    closeBtn.onclick = overlay.onclick = () => { sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden'); }

    function formatDateDisplay(dateStr) {
        const date = new Date(dateStr);
        const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
        return date.toLocaleDateString('vi-VN', options);
    }

    async function loadCalendarDates() {
        let dates = [];
        try {
            const res = await fetch('/api/all-dates');
            dates = await res.json();
        } catch (e) {}

        futureDatesList.innerHTML = '';
        pastDatesList.innerHTML = '';

        const today = new Date();
        const todayStr = today.toISOString().slice(0, 10);
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();

        const endDate = new Date(currentYear, currentMonth + 2, 0);
        for (let d = new Date(today); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dateStr = d.toISOString().slice(0, 10);
            addDateToList(dateStr, futureDatesList, dates.includes(dateStr), dateStr === todayStr);
        }

        dates.filter(d => d < todayStr).sort().reverse().forEach(dateStr => {
            addDateToList(dateStr, pastDatesList, true, false);
        });
    }

    function addDateToList(dateStr, container, hasPlan = false, isToday = false) {
        const div = document.createElement('div');
        const date = new Date(dateStr);

        div.className = `aspect-square flex flex-col items-center justify-center rounded-xl cursor-pointer transition-all hover:scale-110 text-xs ${
            isToday ? 'bg-indigo-600 text-white font-bold shadow-md' :
            hasPlan ? 'bg-indigo-100 border border-indigo-400 text-indigo-900 font-medium' :
            'bg-gray-50 text-gray-600 hover:bg-gray-200'
        }`;
        div.innerHTML = `
            <div class="font-bold">${date.getDate()}</div>
            <div class="opacity-80">${date.toLocaleDateString('vi-VN', { weekday: 'short' })}</div>
        `;
        div.onclick = () => selectDate(dateStr);
        container.appendChild(div);
    }

    async function selectDate(dateStr) {
        currentDate = dateStr;
        selectedDateTitle.textContent = formatDateDisplay(dateStr);
        await loadPlan(dateStr);

        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
    }

    // ===== LOAD PLAN V√Ä HI·ªÇN TH·ªä ƒê√öNG COMPLETED =====
    async function loadPlan(date) {
        let plan = { tasks: [], vocab: [], meals: '', expenses: '', morningTime: null, eveningTime: null };
        try {
            const res = await fetch(`/api/plan/${date}`);
            if (res.ok) plan = await res.json();
        } catch (e) {}

        // X√≥a h·∫øt task c≈©
        tasksList.innerHTML = '';

        // Th√™m l·∫°i task v·ªõi tr·∫°ng th√°i completed
        (plan.tasks || []).forEach((task, index) => {
            const text = typeof task === 'object' ? task.text : task;
            const completed = typeof task === 'object' ? task.completed : false;
            addTaskToList(text, completed, index);
        });

        // Vocab
        const vocabText = (plan.vocab || []).map(v => typeof v === 'object' ? v.text : v).join('\n');
        document.getElementById('vocab').value = vocabText;

        document.getElementById('meals').value = plan.meals || '';
        document.getElementById('expenses').value = plan.expenses || '';

        const morningInput = document.getElementById('morningTime');
        const eveningInput = document.getElementById('eveningTime');
        morningInput.value = plan.morningTime || '';
        eveningInput.value = plan.eveningTime || '';

        document.getElementById('displayMorning').textContent = morningInput.value || '08:00';
        document.getElementById('displayEvening').textContent = eveningInput.value || '20:00';

        morningInput.onchange = eveningInput.onchange = () => {
            document.getElementById('displayMorning').textContent = morningInput.value || '08:00';
            document.getElementById('displayEvening').textContent = eveningInput.value || '20:00';
        };
    }

    // ===== TH√äM TASK V·ªöI TICK COMPLETED =====
    function addTaskToList(text, completed = false, serverIndex = null) {
        if (!text.trim()) return;
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-200';
        div.innerHTML = `
            <label class="flex items-center cursor-pointer flex-1">
                <input type="checkbox" ${completed ? 'checked' : ''} class="mr-3 w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500">
                <span class="text-sm text-gray-800 ${completed ? 'line-through text-gray-500' : ''}">${text.trim()}</span>
            </label>
            <button type="button" class="text-red-600 hover:text-red-800 text-xl font-bold ml-3">√ó</button>
        `;

        // Tick completed ‚Üí g·ªçi API
        div.querySelector('input[type="checkbox"]').onchange = async () => {
            if (serverIndex !== null) {
                await fetch(`/api/plan/${currentDate}/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ taskIndex: serverIndex })
                });
            }
            const span = div.querySelector('span');
            span.classList.toggle('line-through');
            span.classList.toggle('text-gray-500');
        };

        div.querySelector('button').onclick = () => div.remove();
        tasksList.appendChild(div);
    }

    function addTask() {
        const input = document.getElementById('newTask');
        const text = input.value.trim();
        if (!text) return;
        addTaskToList(text, false);
        input.value = '';
    }

    document.getElementById('newTask').addEventListener('keypress', e => {
        if (e.key === 'Enter') addTask();
    });

    // Copy & Paste JSON (gi·ªØ nguy√™n nh∆∞ c≈©, ch·ªâ s·ª≠a nh·ªè)
    function copyJson() {
        const tasks = Array.from(tasksList.querySelectorAll('span')).map(s => s.textContent.trim());
        const jsonData = {
            date: currentDate,
            tasks: tasks || [],
            vocab: document.getElementById('vocab').value,
            meals: document.getElementById('meals').value,
            expenses: document.getElementById('expenses').value,
            morningTime: document.getElementById('morningTime').value || null,
            eveningTime: document.getElementById('eveningTime').value || null
        };
        navigator.clipboard.writeText(JSON.stringify(jsonData, null, 2));
        alert('üìã ƒê√£ copy JSON k·∫ø ho·∫°ch v√†o clipboard!');
    }

    async function pasteJson() {
        try {
            const text = await navigator.clipboard.readText();
            const data = JSON.parse(text);

            if (!data.date || !Array.isArray(data.tasks)) {
                alert('‚ùå JSON kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng!');
                return;
            }

            document.getElementById('vocab').value = data.vocab || '';
            document.getElementById('meals').value = data.meals || '';
            document.getElementById('expenses').value = data.expenses || '';
            document.getElementById('morningTime').value = data.morningTime || '';
            document.getElementById('eveningTime').value = data.eveningTime || '';

            tasksList.innerHTML = '';
            data.tasks.forEach(task => addTaskToList(task));

            document.getElementById('displayMorning').textContent = data.morningTime || '08:00';
            document.getElementById('displayEvening').textContent = data.eveningTime || '20:00';

            alert('üìÑ ƒê√£ paste th√†nh c√¥ng! Nh·∫•n L∆∞u ƒë·ªÉ √°p d·ª•ng.');
        } catch (err) {
            alert('‚ùå L·ªói khi paste JSON.');
        }
    }

    async function savePlan() {
        const tasks = Array.from(tasksList.querySelectorAll('span')).map(s => s.textContent.trim());

        const res = await fetch('/api/plan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                date: currentDate,
                tasks,
                vocab: document.getElementById('vocab').value,
                meals: document.getElementById('meals').value,
                expenses: document.getElementById('expenses').value,
                morningTime: document.getElementById('morningTime').value || null,
                eveningTime: document.getElementById('eveningTime').value || null
            })
        });

        if (res.ok) {
            alert('üéâ L∆∞u th√†nh c√¥ng!');
            await loadCalendarDates();
            await loadPlan(currentDate); // Reload l·∫°i ƒë·ªÉ c√≥ index ch√≠nh x√°c cho tick
        } else {
            alert('‚ùå L·ªói khi l∆∞u');
        }
    }

    // Kh·ªüi ƒë·ªông
    (async () => {
        await loadCalendarDates();
        await selectDate(new Date().toISOString().slice(0, 10));
    })();
</script>
</body>
</html>